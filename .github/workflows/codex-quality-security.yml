name: codex-quality-security

on:
  pull_request:
  push:
    branches: [main, master]
  schedule:
    - cron: "0 13 * * 1"

jobs:
  verify:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.2
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            pnpm install --frozen-lockfile || pnpm install
          fi
          if [ -f ui/package.json ]; then
            pnpm -C ui install --frozen-lockfile || pnpm -C ui install
          fi
      - name: Ensure cargo-audit when required
        run: |
          if grep -q "cargo audit" .codex/verify.commands; then
            cargo install cargo-audit --locked
          fi
      - name: Ensure cargo-llvm-cov when required
        run: |
          if grep -q "run_coverage.sh" .codex/verify.commands; then
            cargo install cargo-llvm-cov --locked
          fi
      - name: Ensure Tauri CLI when required
        run: |
          if grep -q "cargo tauri build" .codex/verify.commands; then
            cargo install tauri-cli --version "^2.0" --locked
          fi
      - name: Run canonical repo gates
        run: bash ./.codex/scripts/run_verify_commands.sh

  secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: TruffleHog secret scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --results=verified,unknown

  sast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/default

  dependency_and_misconfig:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy FS scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scanners: vuln,misconfig,secret
          format: table
          severity: HIGH,CRITICAL
          exit-code: "1"
          ignore-unfixed: true

  scorecard:
    if: github.event_name == 'schedule'
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: OpenSSF Scorecard
        uses: ossf/scorecard-action@v2.3.1
